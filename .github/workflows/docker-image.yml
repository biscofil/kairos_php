on:
  push:
    branches:
    - main
    - release/*

jobs:
  php_test:
    runs-on: ubuntu-latest
    container:
      image: biscofil/kairos_php:no_user
      env:
        # Configure mysql environment variables (https://hub.docker.com/_/mysql/)
        MYSQL_DATABASE: laravel
        MYSQL_ROOT_PASSWORD: your_mysql_root_password
        DB_HOST: mysql
        DB_USERNAME: root
    services:
      mysql:
        image: biscofil/kairos_php:no_user
        env:
          MYSQL_DATABASE: laravel
          MYSQL_ROOT_PASSWORD: your_mysql_root_password
          DB_HOST: mysql
          DB_USERNAME: root
    # coverage: &cov '/^\s*Lines:\s*(\d+.\d+)\%/'
    # Cache libraries in between jobs
    #cache:
    #  key: composer_cache
    #  paths:
    #    - vendor/
    steps:
    - name: test php
      run: |
        cp .env.example .env
        cp db.env.example db.env
        composer install
        rm bootstrap/cache/*
        php artisan config:clear
        php artisan cache:clear
        php artisan route:clear
        php artisan view:clear
        php artisan key:generate
        php artisan migrate
        php artisan db:seed
        php artisan generate:jwt-keypair
        php artisan config:cache
        php artisan route:cache
        echo PHPUNIT TEST
        vendor/phpunit/phpunit/phpunit tests/ --coverage-text --colors=never --configuration phpunit_gitlab.xml

  db_test:
    runs-on: ubuntu-latest
    container:
      image: biscofil/kairos_php:no_user
      env:
        # Configure mysql environment variables (https://hub.docker.com/_/mysql/)
        MYSQL_DATABASE: laravel
        MYSQL_ROOT_PASSWORD: your_mysql_root_password
        DB_HOST: mysql
        DB_USERNAME: root
    steps:
    - name: test db
      run: |
        cp .env.example .env
        composer install
        php artisan key:generate
        php artisan config:cache
        php artisan migrate
        php artisan db:seed
        php artisan migrate:refresh
        php artisan db:seed
   
  npm_test:
    runs-on: ubuntu-latest
    container:
      image: biscofil/kairos_php:no_user
      env:
        # Configure mysql environment variables (https://hub.docker.com/_/mysql/)
        MYSQL_DATABASE: laravel
        MYSQL_ROOT_PASSWORD: your_mysql_root_password
        DB_HOST: mysql
        DB_USERNAME: root
    steps:
    - name: test npm
      run: |
        echo NPM INSTALL
        npm i
        echo NPM TEST
        npm test
